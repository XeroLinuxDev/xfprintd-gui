pkgname=xfprintd-gui
pkgver=0.1.0
pkgrel=1
pkgdesc="GTK4 GUI to manage fingerprint enrollment and PAM integration; includes privileged Polkit helper"
arch=('x86_64')
url="https://xerolinux.xyz"
license=('MIT')
depends=('gtk4' 'polkit' 'glib2' 'fprintd')
makedepends=('rust' 'cargo' 'pkgconf' 'glib2')
provides=('xfprintd-gui')
conflicts=('xfprintd-gui')
options=('!emptydirs')

build() {
  cd "${startdir}/.."

  # Build both GUI and helper tool using workspace
  cargo build --release --locked
}

package() {
  cd "${startdir}/.."

  # Install binaries into /opt/xfprintd-gui
  install -d "${pkgdir}/opt/xfprintd-gui"
  install -Dm755 "target/release/xfprintd-gui" \
    "${pkgdir}/opt/xfprintd-gui/xfprintd-gui"
  install -Dm755 "target/release/xfprintd-gui-helper" \
    "${pkgdir}/opt/xfprintd-gui/xfprintd-gui-helper"

  # Convenience symlink in /usr/bin
  install -d "${pkgdir}/usr/bin"
  ln -s "/opt/xfprintd-gui/xfprintd-gui" "${pkgdir}/usr/bin/xfprintd-gui"

  # Install desktop file
  install -Dm644 "packaging/xfprintd-gui.desktop" \
    "${pkgdir}/usr/share/applications/xfprintd-gui.desktop"

  # Install icon
  install -Dm644 "gui/resources/icons/hicolor/scalable/apps/fingerprint.png" \
    "${pkgdir}/usr/share/icons/hicolor/scalable/apps/xfprintd-gui.png"
}

post_install() {
  gtk-update-icon-cache -q -t -f usr/share/icons/hicolor
}

post_upgrade() {
  post_install
}

post_remove() {
  gtk-update-icon-cache -q -t -f usr/share/icons/hicolor
}
